<template>
{{#each task}}
<div class="page">
  <div class="navbar">
    <div class="navbar-inner sliding">
      <div class="left">
        <a class="link back">
          <i class="icon icon-back"></i>
          <span class="ios-only">Back</span>
        </a>
      </div>
	  <div class="md-only"><div class="img" style="background-image:url({{js 'file_server'}}/user/{{assigned_by_email}}.jpg)"></div></div>
	  <div class="title">{{this.assigned_by_name}}<span class="subtitle">{{js 'date=new Date(this.timestamp_created);months=["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];return ("0" + date.getDate()).slice(-2) + " " + months[(date.getMonth() + 1)] + " " + date.getFullYear() + ", " + ("0" + date.getHours()).slice(-2) + ":" + ("0" + date.getMinutes()).slice(-2) +" "+ this.timestamp_created.split(" ")[2] '}}</span></div>
	  <div class="right">
			<a class="link icon-only popover-open" data-popover=".task-actions">
				<i class="icon material-icons md-only">more_vert</i>
				<i class="icon f7-icons ios-only">more_vertical_fill</i>
			</a>
	</div>
					<div class="popover task-actions">
				<div class="popover-inner">
				  <div class="list simple-list">
					<ul>
					  <li class="popover-close" @click="transferTask">Transfer task</li>
					  <li class="popover-close" @click="markAsCompleted">Mark as completed</li>
					  <li class="popover-close">Close options</li>
					</ul>
				  </div>
				</div>
			  </div>
    </div>
  </div>

	<div class="toolbar messagebar" @messagebar:attachmentdelete="deleteAttachment">
      <div class="toolbar-inner">
        <a class="link icon-only" @click="sheetToggle">
			<i class="material-icons">attach_file</i>
        </a>
        <div class="messagebar-area">
          <textarea class="resizable" placeholder="Post update"></textarea>
        </div>
        <a class="link icon-only demo-send-message-link" @click="sendMessage">
          <i class="icon material-icons md-only">send</i>
          <i class="icon f7-icons ios-only">arrow_up_fill</i>
        </a>
      </div>
	  <div class="messagebar-sheet">
        {{#each images}}
        <label class="checkbox messagebar-sheet-image" style="background-image:url({{this}})" @change="handleAttachment">
          <input type="checkbox">
          <i class="icon icon-checkbox"></i>
        </label>
        {{/each}}
      </div>
    </div>

    <div class="page-content messages-content">
      <div class="messages">
		
		<div class="card">
		<div class="card-header"><small>Title</small><br>{{this.title}}</div>
		<div class="card-content card-content-padding"><small>Description</small><br>{{js "todos=this.todos.replace(/\\|/g,'<br>').replace(/\\:/g,': ');return todos"}}</div>
		<div class="card-footer"><small>Expected completion<br><strong>{{js 'date=new Date(this.timestamp_expected_completion);months=["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];return ("0" + date.getDate()).slice(-2) + " " + months[(date.getMonth() + 1)] + " " + date.getFullYear() + ", " + ("0" + date.getHours()).slice(-2) + ":" + ("0" + date.getMinutes()).slice(-2) +" "+ this.timestamp_expected_completion.split(" ")[2] '}}</strong></small> <small>Status<br><strong>{{this.status}}</strong></small></div>
		</div>

		<div class="messages-title">
			<div class="preloader color-{{js 'color'}}" style="width:44px;height:44px"></div>
			<button @click="startWork" class="col button button-raised button-fill" style="max-width: 150px;margin: 0 auto;">Start Work</button>
		</div>
		


      </div>
    </div>

</div>
{{/each}}
</template>

<style scoped>

.md {{this}} .navbar-inner .img,.ios {{this}} .navbar-inner .img {
	width:44px;
	height:44px;
	border-radius:50%;
	-moz-box-shadow: 0px 0px 2px 0px #000;
	-webkit-box-shadow: 0px 0px 2px 0px #000;
	box-shadow: 0px 0px 2px 0px #000;
	    background-size: 44px 44px;
}

.subtitle i:before, .message-name i:before{
	content: ''!important;
	width: 4px!important;
	height: 4px!important;
	border-radius: 50%!important;
	display: inline-block!important;
	vertical-align: middle!important;
	margin: -1px 8px 0 8px!important;
	background: rgba(255,255,255,.85);
}

.message-name {
    margin-bottom: 4px;
}

.message-name i:before{
	background: rgba(0, 0, 0, 0.43);
}

.card-content-padding {
    padding-top: 10px;
}

.card-header {
	display: block!important;
}

.card small {
	color: grey;
	font-size: 12px!important;
}

.card-footer strong {
	color: #000;
	font-weight: 400;
    font-size: 14px;
}

.navbar .right, .toolbar.messagebar, .messages-title .button {
	display: none;
}

.message-bubble {
	-webkit-box-shadow: 0 1px 3px rgba(0,0,0,.12), 0 1px 2px rgba(0,0,0,.24);
    box-shadow: 0 1px 3px rgba(0,0,0,.12), 0 1px 2px rgba(0,0,0,.24);
	min-width: 167px!important;
	cursor: pointer;
}

.message-bubble:before {
	box-shadow: 0px 1.4px 0.1px rgba(0,0,0,.24);
}

.message-sent {
	margin-right: 15px!important;
}

.messagebar-sheet {
	height: 48px;
	padding: 15px;
}

.messagebar-sheet{
	border-top: 1px solid #d1d1d1;
}

.message {
	max-width: 88%!important;
	min-width: 270px!important;
}

.message+.message:not(.message-first) {
	margin-top: 45px!important;
}

.message-sent .message-text small {
	text-align: right;
}

.message-text small {
    color: grey;
    font-weight: 300;
    font-size: 12px;
    display: none;
    margin-bottom: 4px;
    width: 100%;
    clear: both;
}

.message-avatar {
	cursor: pointer;
}
</style>

<script>
color = app.data.settings.color;;
file_server = app.data.config.file_server;

return {
	data: function () {
    return {
			task: function(){id=this.$route.query.id;return app.form.getFormData('tasks').filter(function(a){return a.id==id})},
		}
	},
	on: {
		pageBeforeRemove: function (e, page) {
			var self = this;
			if (self.messagebar) self.messagebar.destroy();
		},

		pageInit: function (e, page) {
        var self = this;
        var app = self.$app;
        self.messagebar = app.messagebar.create({
          el: page.$el.find('.messagebar'),
          attachments: []
        })
        self.messages = app.messages.create({
          el: page.$el.find('.messages'),
          firstMessageRule: function (message, previousMessage, nextMessage) {
            if (message.isTitle) return false;
            if (!previousMessage || previousMessage.type !== message.type || previousMessage.name !== message.name) return true;
            return false;
          },
          lastMessageRule: function (message, previousMessage, nextMessage) {
            if (message.isTitle) return false;
            if (!nextMessage || nextMessage.type !== message.type || nextMessage.name !== message.name) return true;
            return false;
          },
          tailMessageRule: function (message, previousMessage, nextMessage) {
            if (message.isTitle) return false;
            if (!nextMessage || nextMessage.type !== message.type || nextMessage.name !== message.name) return true;
            return false;
          }
        })
      },
	  
	  pageAfterIn: function(e, page) {
		var app = this.$app;
		var id = this.$route.query.id;
		setTimeout(function(){http_api__post({methods:app.views.current.name,goto:app.views.current.name},'background',{todo: 'get_task', id: id});},1000);			
	  }
	},
    methods: {
		taskNotFound: function(){
			$('.messages-title').html('Sorry! Task not found or may have been deleted by its creator.');
		},
		getTaskSuccess: function(view, arguments){
			comments = arguments.work_progress_comments;
			if(comments==''){
				$('.messages-title .preloader').hide();
				$('.messages-title .button').show();
			}else{
				comments = JSON.parse('['+comments+']');

				for (var i = 0; i < comments.length; i++){
				
					months=["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];
					date=new Date(comments[i].datetime);
					
					day = ("0" + date.getDate()).slice(-2) + " " + months[date.getMonth()] + " " + date.getFullYear() + ", ";

					yesterday = new Date();yesterday.setDate(new Date().getDate()-1);
					
					if(date.toString().substring(0,10)==new Date().toString().substring(0,10)){day=''}
					else if(date.toString().substring(0,10)==yesterday.toString().substring(0,10)){day='Yesterday, '};
					
					
					console.log(date+" = "+yesterday)

					time = ("0" + date.getHours() % 12 || 12).slice(-2) + ":" + ("0" + date.getMinutes()).slice(-2) + ":" + ("0" + date.getSeconds()).slice(-2) + " " + comments[i].datetime.split(" ")[2];

					received_or_sent_class = 'received';
					if(comments[i].email==arguments.assigned_to_email){received_or_sent_class = 'sent';}
					else if(comments[i].email==arguments.assigned_by_email){received_or_sent_class = 'received'}

					if(comments[i].email==app.data.warrior.email){received_or_sent_class += ' sent_by_me';}

					html = '<div class="message message-'+received_or_sent_class+' message-tail"><div data-action-get-warrior="'+comments[i].email+'" class="message-avatar" style="background-image:url('+app.data.config.file_server+'/user/'+comments[i].email+'.jpg)"></div><div class="message-content"><div class="message-name">'+day+time+'</div><div class="message-bubble"><div class="message-text"><small>'+comments[i].name+'</small>'+comments[i].comment+'</div></div></div></div>';
					$(html).insertAfter('.messages-title');
				}
				$('.navbar .right, .toolbar.messagebar').show();
				$('.messages-title').hide();
			}
			
			
			$('.message-bubble').on('click',function(){
				if($(this).find('small').css('display')=='none'){$(this).find('small').show();}else{$(this).find('small').hide();}
			});
			
		},
		startWork: function(){
			var app = this.$app;
			$('.messages-title .button').hide();
			$('.messages-title .preloader').show();
			http_api__post({methods:app.views.current.name,goto:app.views.current.name,onAlertCallback:'startWorkFailed'},'silent',{todo: 'post_task__comment', id: this.$route.query.id, name: app.data.warrior.name, email: app.data.warrior.email, comment: 'I\'ve started working on this.'});
		},
		startWorkFailed: function(){
			var app = this.$app;
			$('.messages-title .preloader').hide();
			$('.messages-title .button').show();
		},
		post_task__comment_success: function(){
			var app = this.$app;
			$('.messages-title').hide();
			alert('post_task__comment_success');
		},	
		attachLocalFile: function(){
			app.dialog.alert('Local file upload feature is getting built into tasks module. Please give us sometime to have everything built.', 'We\'re sorry, Warrior!')
		},
		attachRemoteFile: function(){
			app.dialog.alert('Remote file upload feature is getting built into tasks module. Please give us sometime to have everything built.', 'We\'re sorry, Warrior!')
		},
		sheetToggle: function () {
        var self = this;
			self.messagebar.sheetToggle();
		},		
		sheetToggle: function () {
        var self = this;
        self.messagebar.sheetToggle();
      },
      deleteAttachment: function (e, index) {
        var self = this;
        var image = self.messagebar.attachments.splice(index, 1)[0];
        self.messagebar.renderAttachments();
        self.checkAttachments();
        // Uncheck in sheet
        var imageIndex = self.images.indexOf(image);
        self.$el.find('.messagebar-sheet .checkbox').eq(imageIndex).find('input').prop('checked', false);
      },
      handleAttachment: function (e) {
        var self = this;
        var $$ = self.$$;
        var index = $(e.target).parents('label.checkbox').index();
        var image = self.images[index];
        if (e.target.checked) {
          // Add to attachments
          self.messagebar.attachments.unshift(image)
        } else {
          // Remove from attachments
          self.messagebar.attachments.splice(self.messagebar.attachments.indexOf(image), 1);
        }
        self.messagebar.renderAttachments();
        self.checkAttachments();
      },
      checkAttachments: function () {
        var self = this;
        if (self.messagebar.attachments.length > 0) {
          self.messagebar.attachmentsShow();
          self.messagebar.setPlaceholder('Add comment or Send');
        } else {
          self.messagebar.attachmentsHide();
          self.messagebar.setPlaceholder('Message');
        }
      },
      sendMessage: function () {
        var self = this;
        var text = self.messagebar.getValue().replace(/\n/g, '<br>').trim();
        var messagesToSend = [];
        self.messagebar.attachments.forEach(function (attachment) {
          var size = attachment.split('lorempixel.com/')[1].split('/');
          messagesToSend.push({
            image: '<img src="' + attachment + '" style="width: ' + (size[0]/2) + 'px; height: ' + (size[1]/2) + 'px">'
          });
        });
        if (text.trim().length) {
          messagesToSend.push({
            text: text
          });
        }
        // Reset attachments
        self.messagebar.attachments = [];
        self.checkAttachments();
        // Hide sheet
        self.messagebar.sheetHide();
        // Uncheck selected images in sheet
        self.messagebar.$sheetEl.find('input').prop('checked', false);
        // Clear area
        self.messagebar.clear();
        // Focus area
        if (text.length) self.messagebar.focus();
        // Send message
        self.messages.addMessages(messagesToSend);

        // Mock response
        if (self.responseInProgress) return;
        self.responseInProgress = true;
        setTimeout(function () {
          var answer = self.answers[Math.floor(Math.random() * self.answers.length)];
          var person = self.people[Math.floor(Math.random() * self.people.length)];
          self.messages.showTyping({
            header: person.name + ' is typing',
            avatar: person.avatar
          });
          setTimeout(function () {
            self.messages.addMessage({
              text: answer,
              type: 'received',
              name: person.name,
              avatar: person.avatar
            });
            self.messages.hideTyping();
            self.responseInProgress = false;
          }, 4000);
        }, 1000);
      },
		
      updateTask: function(){
		var name = $("#name").val().trim();
		var email = $("#email").val().trim().toLowerCase();
		var approver = $("#approver").val().trim();
		var business_justification = $("#business_justification").val().trim();
		if(name==""){app.dialog.alert('Please enter your name.', 'Yo!',function(){$("#name").focus()});return false;}
		if(email==""){app.dialog.alert('Please enter your email address.', 'Yo!',function(){$("#email").focus()});return false;}
		if(email.substr(email.length - 8)!="@jcp.com"){app.dialog.alert('Please enter your xxxx@jcp.com email address.', 'Yo!',function(){$("#email").focus()});return false;}
		if(email=="xxxx@jcp.com"){app.dialog.alert('Please enter a valid email address.', 'Yo!',function(){$("#email").focus()});return false;}
		if(business_justification==""){app.dialog.alert('Please provide your business justification.', 'Yo!',function(){$("#business_justification").focus()});return false;}
		if(business_justification.length<8){app.dialog.alert('Please provide a valid business justification.', 'Yo!',function(){$("#business_justification").focus()});return false;}
		//http_api__post('form', {todo: 'create_task', assigned_by_name: name, assigned_by_email: email, title: name + ' requested JCP+ support team assistance', todos: business_justification, success_todo: 'alert_next', success_todo_title: 'Thank you!', success_todo_message: 'We have received your support request. Help is on the way!', success_todo_next: 'refresh_tasks_created_by_me'});
      },
    },
  }
</script>